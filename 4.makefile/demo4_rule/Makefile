# Makefile —— Make 规则类型完整演示

CC := gcc
CFLAGS := -Wall -g -Iinclude

SRC_DIR := src
OBJ_DIR := build
TARGET := myapp

# 获取所有 .c 文件
SRCS := $(wildcard $(SRC_DIR)/*.c)

# 显式把 .c → .o
OBJS := $(patsubst $(SRC_DIR)/%.c, $(OBJ_DIR)/%.o, $(SRCS))

# -----------------------------------------------------------------------------
# 1️⃣ 显式规则：直接写明目标与依赖（用于链接）
# -----------------------------------------------------------------------------
# 这是最常见的手写规则，明确指明“这个目标依赖哪些文件，用什么命令构建它”
$(TARGET): $(OBJS)
	@echo "[显式规则] 链接生成最终程序: $@"
	$(CC) $(CFLAGS) -o $@ $^

# -----------------------------------------------------------------------------
# 2️⃣ 模式规则（隐含规则）：使用通配符 %.o: %.c
# -----------------------------------------------------------------------------
# 用来匹配所有 .o ← .c 的编译规则，是写 Makefile 的推荐方式
# 自动变量 $< 表示第一个依赖，$@ 表示目标
#
# Make 的行为：
#   对同一个目标，多条规则只保留最后定义的一个 recipe。
#   静态模式规则在这个例子中“掐断”了模式规则的执行。
#   简单讲：如果为同一个目标（如 main.o）同时定义了两种规则，后定义的规则生效，忽略前面的。
$(OBJ_DIR)/%.o: $(SRC_DIR)/%.c
	@mkdir -p $(OBJ_DIR)
	@echo "[模式规则] 编译 $< -> $@"
	$(CC) $(CFLAGS) -c $< -o $@

# -----------------------------------------------------------------------------
# 3️⃣ 静态模式规则（更可控的隐式规则）
# -----------------------------------------------------------------------------
# 一次定义多组“目标 : 依赖”规则，适合组合编译逻辑更复杂时使用
# $(OBJ_DIR)/main.o : $(SRC_DIR)/main.c 类似于单独列出
$(OBJS): $(OBJ_DIR)/%.o : $(SRC_DIR)/%.c
	@mkdir -p $(OBJ_DIR)
	@echo "[静态模式规则] 构建 $@ from $<"
	$(CC) $(CFLAGS) -c $< -o $@

# -----------------------------------------------------------------------------
# 4️⃣ 伪目标（PHONY）：不是实际文件名的目标
# -----------------------------------------------------------------------------
.PHONY: all clean info

# -----------------------------------------------------------------------------
# 5️⃣ 缺省规则：最先执行的默认规则
# -----------------------------------------------------------------------------
# 通常命名为 all，列出你要构建的一切目标
all: $(TARGET)

# -----------------------------------------------------------------------------
# 清理构建产物
# -----------------------------------------------------------------------------
clean:
	@echo "[PHONY] 清理构建产物"
	rm -rf $(OBJ_DIR) $(TARGET)

# -----------------------------------------------------------------------------
# 6️⃣ info：展示 Make 隐含规则（内置规则）
# -----------------------------------------------------------------------------
info:
	@echo "🎯 内置规则举例（自动支持如下规则）:"
	@echo "%.o : %.c"
	@echo "%.c : %.y  # Bison"
	@echo "%.o : %.s  # 汇编"
	@echo "无需定义规则，make 会自动应用这些内置规则"

